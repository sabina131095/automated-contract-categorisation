import pandas as pd
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.linear_model import LogisticRegression
from sklearn.metrics import classification_report, accuracy_score, confusion_matrix
import matplotlib.pyplot as plt
import seaborn as sns

# Load your dataset (replace with the actual path)
df = pd.read_excel('/content/contracts_hybrid_predictions_true.xlsx')

# Vectorizer setup
vectorizer = TfidfVectorizer(max_features=3000, ngram_range=(1,2), stop_words='english')

# Split the data into train and test (You can split as per your needs)
from sklearn.model_selection import train_test_split
train_df, test_df = train_test_split(df, test_size=0.25, stratify=df['category'], random_state=42)

# Vectorize train and test data
X_train_vec = vectorizer.fit_transform(train_df['text'])
X_test_vec = vectorizer.transform(test_df['text'])

y_train = train_df['category']
y_test = test_df['category']

# Train the logistic regression model
clf = LogisticRegression(max_iter=1000, multi_class='multinomial', solver='lbfgs')
clf.fit(X_train_vec, y_train)

# Make predictions
y_pred = clf.predict(X_test_vec)

# Evaluate the model
accuracy = accuracy_score(y_test, y_pred)
print(f"Accuracy: {accuracy * 100:.2f}%")

# Print the classification report
print("\nClassification Report:")
print(classification_report(y_test, y_pred))

# # Confusion matrix
# labels = sorted(list(set(y_test) | set(y_pred)))  # Combine unique labels from both true and predicted values
# cm = confusion_matrix(y_test, y_pred, labels=labels)

# # Plot confusion matrix
# plt.figure(figsize=(12,10))
# sns.heatmap(cm, annot=True, fmt='d', cmap='Blues', xticklabels=labels, yticklabels=labels)
# plt.xlabel('Predicted')
# plt.ylabel('True')
# plt.title('Confusion Matrix')
# plt.show()

# If you want to save the predictions along with file_name and text in the output
results_df = pd.DataFrame({
    'file_name': test_df['file_name'],
    'text': test_df['text'],
    'true_category': test_df['category'],
    'predicted_category': y_pred
})

# Save to Excel
results_df.to_excel('/content/contracts_predictions_output.xlsx', index=False)
print("Saved predictions to /content/contracts_predictions_output.xlsx")

from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score

accuracy = accuracy_score(y_test, y_pred)*100
precision = precision_score(y_test, y_pred, average='weighted')*100
recall = recall_score(y_test, y_pred, average='weighted')*100
f1 = f1_score(y_test, y_pred, average='weighted')*100

print(f"Accuracy: {accuracy:.2f}%")
print(f"Precision: {precision:.2f}%")
print(f"Recall: {recall:.2f}%")
print(f"F1 Score: {f1:.2f}%")
